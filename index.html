<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>水準測量</title>
  <style>
    :root{
      --bd:#d0d7de;
      --bg:#ffffff;
      --bg2:#f6f8fa;
      --sum:#fff8c5;
      --txt:#24292f;
      --muted:#57606a;
      --radius:10px;
    }

    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      margin: 12px;
      color: var(--txt);
      background: var(--bg);
      -webkit-text-size-adjust: 100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .titleblock h1{ margin:0; font-size: 18px; }
    .titleblock .note{ margin: 4px 0 0; color:var(--muted); font-size: 12px; line-height: 1.4; }

    .btn{
      border:1px solid var(--bd);
      background: var(--bg2);
      padding: 10px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-size: 14px;
      min-height: 44px;
      white-space: nowrap;
    }

    .wrap{
      border:1px solid var(--bd);
      border-radius: var(--radius);
      max-width: 100%;
      overflow: hidden;
    }

    .section-title{
      font-weight: 800;
      padding: 8px 10px;
      background: var(--bg2);
      border-bottom: 1px solid var(--bd);
      font-size: 14px;
    }

    table{
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      background: var(--bg);
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 3;
      background: var(--bg2);
      border:1px solid var(--bd);
      padding: 8px 4px;
      text-align:center;
      font-weight:700;
      font-size: 12px;
      white-space: nowrap;
    }
    thead tr:nth-child(2) th{
      top: 38px;
      z-index: 3;
    }

    tbody td, tfoot td{
      border:1px solid var(--bd);
      padding: 4px;
      text-align:center;
      font-size: 12px;
      white-space: nowrap;
    }

    input{
      width: 100%;
      box-sizing: border-box;
      padding: 6px 2px;
      border: 1px solid var(--bd);
      border-radius: 8px;
      font-size: 13px;
      text-align: center;
      background: #fff;
      min-height: 36px;
      font-variant-numeric: tabular-nums;
    }

    input[readonly]{
      background:#fbfbfb;
      color:#111;
    }

    .col-no input{ font-size: 11px; padding: 6px 1px; }
    .col-dist input{ font-size: 11px; padding: 6px 1px; }
    .col-plus input[readonly],
    .col-minus input[readonly]{
      font-size: 14px;
      padding: 6px 1px;
    }

    /* Column widths for main tables */
    th:nth-child(1), td:nth-child(1){ width: 8%; }   /* 番号 */
    th:nth-child(2), td:nth-child(2){ width: 12%; }  /* 距離 */
    th:nth-child(3), td:nth-child(3){ width: 16%; }  /* 後視 */
    th:nth-child(4), td:nth-child(4){ width: 16%; }  /* 前視 */
    th:nth-child(5), td:nth-child(5){ width: 24%; }  /* 高低差 + */
    th:nth-child(6), td:nth-child(6){ width: 24%; }  /* 高低差 - */

    tfoot td{
      background: var(--sum);
      font-weight: 700;
    }
    tfoot input{ font-weight: 700; }

    .section-sep{
      height: 10px;
      border-top: 2px solid var(--bd);
      margin: 10px 0;
    }

    .btns{
      display:flex;
      gap:10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .addrow{
      width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      line-height: 1;
      min-height: 36px;
      border: 1px dashed var(--bd);
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
    }
    .addrow:active{ filter: brightness(0.97); }

    /* Summary (top) row table */
    .meta{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .meta th, .meta td{
      border: 1px solid var(--bd);
      padding: 6px 6px;
      text-align: center;
      font-size: 12px;
      background: #fff;
    }
    .meta th{
      background: var(--bg2);
      font-weight: 800;
    }
    .meta input{
      min-height: 36px;
      font-size: 13px;
    }

    @media (max-width: 360px){
      thead th{ font-size: 11px; padding: 6px 2px; }
      input{ font-size: 12px; min-height: 34px; }
      .col-plus input[readonly], .col-minus input[readonly]{ font-size: 13px; }
      .btn{ font-size: 13px; padding: 10px 10px; }
      .meta th, .meta td{ font-size: 11px; padding: 6px 4px; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="titleblock">
      <h1>水準測量</h1>
      <div class="note">
        計算: <b>Δ = 後視 − 前視</b> ／ Δ&gt;0 → 高低差(＋)=|Δ|、Δ&lt;0 → 高低差(－)=|Δ|（3桁小数）
      </div>
    </div>
    <button id="exportCsvBtn" class="btn" type="button">CSV保存</button>
  </div>

  <div class="wrap">
    <!-- top summary row -->
    <table class="meta" aria-label="測量概要">
      <thead>
        <tr>
          <th>自</th>
          <th>至</th>
          <th>既知点間の高低差</th>
          <th>観測の高低差</th>
          <th>出合差</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input id="meta_from" type="text" placeholder="入力" inputmode="decimal"></td>
          <td><input id="meta_to" type="text" placeholder="入力" inputmode="decimal"></td>
          <td><input id="meta_known" type="text" readonly placeholder="計算"></td>
          <td><input id="meta_obs" type="text" readonly placeholder="計算"></td>
          <td><input id="meta_misclose" type="text" readonly placeholder="計算"></td>
        </tr>
      </tbody>
    </table>

    <div class="section-sep"></div>

    <div class="section-title">水準測量（往）</div>
    <table id="table1">
      <thead>
        <tr>
          <th rowspan="2">番号</th>
          <th rowspan="2">距離</th>
          <th rowspan="2">後視</th>
          <th rowspan="2">前視</th>
          <th colspan="2">高低差</th>
        </tr>
        <tr>
          <th>＋</th>
          <th>－</th>
        </tr>
      </thead>
      <tbody id="body1"></tbody>
      <tfoot>
        <tr>
          <td>合計</td>
          <td><input id="sum1_dist" readonly></td>
          <td><input id="sum1_bs" readonly></td>
          <td><input id="sum1_fs" readonly></td>
          <td><input id="sum1_plus" readonly></td>
          <td><input id="sum1_minus" readonly></td>
        </tr>
        <tr>
          <td>距離×2</td>
          <td><input id="sum1_dist2" readonly></td>
          <td><input readonly></td>
          <td><input readonly></td>
          <td><input readonly></td>
          <td><input readonly></td>
        </tr>
      </tfoot>
    </table>

    <div class="section-sep"></div>

    <div class="section-title">水準測量（復）</div>
    <table id="table2">
      <thead>
        <tr>
          <th rowspan="2">番号</th>
          <th rowspan="2">距離</th>
          <th rowspan="2">後視</th>
          <th rowspan="2">前視</th>
          <th colspan="2">高低差</th>
        </tr>
        <tr>
          <th>＋</th>
          <th>－</th>
        </tr>
      </thead>
      <tbody id="body2"></tbody>
      <tfoot>
        <tr>
          <td>合計</td>
          <td><input id="sum2_dist" readonly></td>
          <td><input id="sum2_bs" readonly></td>
          <td><input id="sum2_fs" readonly></td>
          <td><input id="sum2_plus" readonly></td>
          <td><input id="sum2_minus" readonly></td>
        </tr>
        <tr>
          <td>距離×2</td>
          <td><input id="sum2_dist2" readonly></td>
          <td><input readonly></td>
          <td><input readonly></td>
          <td><input readonly></td>
          <td><input readonly></td>
        </tr>
      </tfoot>
    </table>

    <table>
      <tbody>
        <tr>
          <td style="border:0; padding:10px;">
            <button id="addRowBothBtn" class="addrow" type="button" title="往と復に行を追加">＋</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="btns">
    <button id="clearBtn" class="btn" type="button">全クリア</button>
  </div>

  <script>
    const INITIAL_ROWS = 10;

    function toHalfWidth(str){
      return (str ?? "")
        .toString()
        .replace(/[０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
        .replace(/．/g, ".")
        .replace(/－/g, "-")
        .replace(/，/g, ",")
        .trim();
    }

    function parseNum(v){
      const t = toHalfWidth(v);
      if (t === "") return null;
      const n = Number(t.replace(/,/g,""));
      return Number.isFinite(n) ? n : null;
    }

    function fmt(x){
      if (x === null) return "";
      return (Math.round(x * 1000) / 1000).toFixed(3);
    }

    function signOf(x){
      if (x > 0) return 1;
      if (x < 0) return -1;
      return 0;
    }

    function makeCellInput(id, readonly=false){
      const td = document.createElement("td");
      const inp = document.createElement("input");
      inp.id = id;
      inp.autocomplete = "off";
      inp.spellcheck = false;
      inp.inputMode = "decimal";
      inp.type = "text";
      if (readonly) inp.readOnly = true;
      td.appendChild(inp);
      return td;
    }

    function addDataRow(tableId){
      const body = document.getElementById(`body${tableId}`);
      const rowIndex = body.querySelectorAll("tr[data-row='data']").length + 1;

      const tr = document.createElement("tr");
      tr.dataset.row = "data";

      const tdNo   = makeCellInput(`t${tableId}_no_${rowIndex}`, true);
      const tdDist = makeCellInput(`t${tableId}_dist_${rowIndex}`);
      const tdBs   = makeCellInput(`t${tableId}_bs_${rowIndex}`);
      const tdFs   = makeCellInput(`t${tableId}_fs_${rowIndex}`);
      const tdPlus = makeCellInput(`t${tableId}_plus_${rowIndex}`, true);
      const tdMinus= makeCellInput(`t${tableId}_minus_${rowIndex}`, true);

      tdNo.classList.add("col-no");
      tdDist.classList.add("col-dist");
      tdPlus.classList.add("col-plus");
      tdMinus.classList.add("col-minus");

      tr.appendChild(tdNo);
      tr.appendChild(tdDist);
      tr.appendChild(tdBs);
      tr.appendChild(tdFs);
      tr.appendChild(tdPlus);
      tr.appendChild(tdMinus);

      body.appendChild(tr);

      [tdDist, tdBs, tdFs].forEach((td)=>{
        td.querySelector("input").addEventListener("input", ()=>{
          calcRow(tableId, rowIndex);
          calcSums(tableId);
          if (tableId === 1) syncDistanceReverse();
          calcMeta(); // NEW: update top calculations
        });
      });

      return rowIndex;
    }

    function getRowCount(tableId){
      const body = document.getElementById(`body${tableId}`);
      return body.querySelectorAll("tr[data-row='data']").length;
    }

    function setAutoNumbers(){
      const total = getRowCount(1);
      for (let i=1;i<=total;i++){
        const a = document.getElementById(`t1_no_${i}`);
        const b = document.getElementById(`t2_no_${i}`);
        if (a) a.value = i;
        if (b) b.value = i;
      }
    }

    function calcRow(tableId, i){
      const bs = parseNum(document.getElementById(`t${tableId}_bs_${i}`).value);
      const fs = parseNum(document.getElementById(`t${tableId}_fs_${i}`).value);
      const plusEl  = document.getElementById(`t${tableId}_plus_${i}`);
      const minusEl = document.getElementById(`t${tableId}_minus_${i}`);

      plusEl.value = "";
      minusEl.value = "";

      if (bs === null || fs === null) return;

      const d = bs - fs;
      const a = Math.abs(d);

      if (d > 0) plusEl.value = fmt(a);
      else if (d < 0) minusEl.value = fmt(a);
    }

    function sumCol(tableId, prefix){
      let s = 0;
      let any = false;
      const rows = getRowCount(tableId);
      for (let i=1;i<=rows;i++){
        const el = document.getElementById(`t${tableId}_${prefix}_${i}`);
        if (!el) continue;
        const v = parseNum(el.value);
        if (v !== null){ s += v; any = true; }
      }
      return any ? s : null;
    }

    function calcSums(tableId){
      const dist = sumCol(tableId, "dist");
      document.getElementById(`sum${tableId}_dist`).value  = fmt(dist);
      document.getElementById(`sum${tableId}_bs`).value    = fmt(sumCol(tableId, "bs"));
      document.getElementById(`sum${tableId}_fs`).value    = fmt(sumCol(tableId, "fs"));
      document.getElementById(`sum${tableId}_plus`).value  = fmt(sumCol(tableId, "plus"));
      document.getElementById(`sum${tableId}_minus`).value = fmt(sumCol(tableId, "minus"));

      const dist2 = (dist === null) ? null : dist * 2;
      document.getElementById(`sum${tableId}_dist2`).value = fmt(dist2);
    }

    // NEW: totals for observation height difference using B) method:
    // Total = Σ(plus) - Σ(minus)
    function signedTotalFromPlusMinus(tableId){
      const p = sumCol(tableId, "plus") ?? 0;
      const m = sumCol(tableId, "minus") ?? 0;
      // If absolutely nothing entered in both columns, treat as null
      const any = (sumCol(tableId, "plus") !== null) || (sumCol(tableId, "minus") !== null);
      if (!any) return null;
      return p - m;
    }

    // NEW: top meta calculations
    function calcMeta(){
      const from = parseNum(document.getElementById("meta_from").value);
      const to   = parseNum(document.getElementById("meta_to").value);

      // 既知点間の高低差 = 至 - 自
      const known = (from === null || to === null) ? null : (to - from);
      document.getElementById("meta_known").value = fmt(known);

      // 観測の高低差
      const totalGo = signedTotalFromPlusMinus(1);
      const totalBack = signedTotalFromPlusMinus(2);

      let obs = null;
      if (totalGo !== null && totalBack !== null){
        const rawAvg = (totalGo + totalBack) / 2;

        const s = signOf(totalGo);
        if (s === 0){
          // If 往 total is exactly 0, keep raw average sign
          obs = rawAvg;
        } else {
          obs = s * Math.abs(rawAvg);
        }
      }
      document.getElementById("meta_obs").value = fmt(obs);

      // 出合差 = 観測 - 既知
      const misclose = (obs === null || known === null) ? null : (obs - known);
      document.getElementById("meta_misclose").value = fmt(misclose);
    }

    function recalcAll(){
      [1,2].forEach(t=>{
        const rows = getRowCount(t);
        for (let i=1;i<=rows;i++) calcRow(t, i);
        calcSums(t);
      });
      calcMeta();
    }

    // 復 distance = reverse order of 往 distance
    function syncDistanceReverse(){
      const n = getRowCount(1);
      for (let i=1;i<=n;i++){
        const goEl = document.getElementById(`t1_dist_${i}`);
        const backEl = document.getElementById(`t2_dist_${n - i + 1}`);
        if (goEl && backEl) backEl.value = toHalfWidth(goEl.value);
      }
      calcSums(2);
    }

    function build(){
      for (let i=0;i<INITIAL_ROWS;i++){
        addDataRow(1);
        addDataRow(2);
      }
      setAutoNumbers();
      syncDistanceReverse();
      recalcAll();
    }

    document.getElementById("addRowBothBtn").addEventListener("click", ()=>{
      addDataRow(1);
      addDataRow(2);
      setAutoNumbers();
      syncDistanceReverse();
      recalcAll();
    });

    // meta inputs trigger meta calc
    document.getElementById("meta_from").addEventListener("input", calcMeta);
    document.getElementById("meta_to").addEventListener("input", calcMeta);

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      [1,2].forEach(t=>{
        const rows = getRowCount(t);
        for (let i=1;i<=rows;i++){
          ["dist","bs","fs","plus","minus"].forEach(p=>{
            const el = document.getElementById(`t${t}_${p}_${i}`);
            if (el) el.value = "";
          });
        }
        calcSums(t);
      });
      syncDistanceReverse();

      // clear meta
      document.getElementById("meta_from").value = "";
      document.getElementById("meta_to").value = "";
      document.getElementById("meta_known").value = "";
      document.getElementById("meta_obs").value = "";
      document.getElementById("meta_misclose").value = "";

      recalcAll();
    });

    // CSV export
    function csvEscape(v){
      const s = (v ?? "").toString();
      if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function buildCsv(){
      const rows = [];

      rows.push(["自","至","既知点間の高低差","観測の高低差","出合差"]);
      rows.push([
        document.getElementById("meta_from").value,
        document.getElementById("meta_to").value,
        document.getElementById("meta_known").value,
        document.getElementById("meta_obs").value,
        document.getElementById("meta_misclose").value
      ]);
      rows.push([]);

      rows.push(["区分","番号","距離","後視","前視","高低差(+)","高低差(-)"]);

      const n = getRowCount(1);

      for (let i=1;i<=n;i++){
        rows.push([
          "往",
          document.getElementById(`t1_no_${i}`).value,
          toHalfWidth(document.getElementById(`t1_dist_${i}`).value),
          toHalfWidth(document.getElementById(`t1_bs_${i}`).value),
          toHalfWidth(document.getElementById(`t1_fs_${i}`).value),
          toHalfWidth(document.getElementById(`t1_plus_${i}`).value),
          toHalfWidth(document.getElementById(`t1_minus_${i}`).value),
        ]);
      }
      for (let i=1;i<=n;i++){
        rows.push([
          "復",
          document.getElementById(`t2_no_${i}`).value,
          toHalfWidth(document.getElementById(`t2_dist_${i}`).value),
          toHalfWidth(document.getElementById(`t2_bs_${i}`).value),
          toHalfWidth(document.getElementById(`t2_fs_${i}`).value),
          toHalfWidth(document.getElementById(`t2_plus_${i}`).value),
          toHalfWidth(document.getElementById(`t2_minus_${i}`).value),
        ]);
      }

      rows.push([]);
      rows.push(["往合計","",document.getElementById("sum1_dist").value,document.getElementById("sum1_bs").value,document.getElementById("sum1_fs").value,document.getElementById("sum1_plus").value,document.getElementById("sum1_minus").value]);
      rows.push(["往距離×2","",document.getElementById("sum1_dist2").value,"","","",""]);
      rows.push(["復合計","",document.getElementById("sum2_dist").value,document.getElementById("sum2_bs").value,document.getElementById("sum2_fs").value,document.getElementById("sum2_plus").value,document.getElementById("sum2_minus").value]);
      rows.push(["復距離×2","",document.getElementById("sum2_dist2").value,"","","",""]);

      // optional: add signed totals used for 観測の高低差 (debug/trace)
      rows.push([]);
      rows.push(["往 高低差合計(符号付) = Σ(+)−Σ(−)","", fmt(signedTotalFromPlusMinus(1))]);
      rows.push(["復 高低差合計(符号付) = Σ(+)−Σ(−)","", fmt(signedTotalFromPlusMinus(2))]);

      return rows.map(r => r.map(csvEscape).join(",")).join("\n");
    }

    document.getElementById("exportCsvBtn").addEventListener("click", async ()=>{
      syncDistanceReverse();
      recalcAll();

      const csv = buildCsv();
      const blob = new Blob([csv], {type: "text/csv;charset=utf-8"});

      const now = new Date();
      const pad = (n)=> String(n).padStart(2,"0");
      const fname = `suijun_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}.csv`;

      if (window.showSaveFilePicker) {
        try{
          const handle = await window.showSaveFilePicker({
            suggestedName: fname,
            types: [{ description: "CSV", accept: {"text/csv": [".csv"]} }]
          });
          const writable = await handle.createWritable();
          await writable.write(blob);
          await writable.close();
          return;
        } catch(e){
          // cancel -> fall back
        }
      }

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });

    build();
  </script>
</body>
</html>
